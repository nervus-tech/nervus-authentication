name: CD Staging - Authentication Service

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'nervus-authentication'
        type: string

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            # Navigate to service directory
            cd /opt/nervus.tech/${{ github.event.inputs.service || 'nervus-authentication' }}
            
            # Pull latest changes
            git pull origin develop
            
            # Stop existing service
            docker-compose -f authentication/docker-compose-staging.yml down || true
            
            # Pull latest image
            docker pull ghcr.io/nervus-tech/nervus-authentication:latest
            
            # Start service
            docker-compose -f authentication/docker-compose-staging.yml up -d
            
            # Wait for service to be healthy
            sleep 30
            
            # Health check
            curl -f http://localhost:8100/actuator/health || exit 1

      - name: Integration Test
        run: |
          # Test service integration with other services
          curl -f http://${{ secrets.STAGING_HOST }}:8100/actuator/health || exit 1

      - name: Database Connectivity Test
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          HEALTH=$(curl -s http://${{ secrets.STAGING_HOST }}:8100/actuator/health)
          echo "$HEALTH"
          echo "$HEALTH" | jq -e '.components.db.status == "UP"' >/dev/null 2>&1 || { echo "DB health not UP"; exit 1; }

      - name: API Gateway Routing Test
        run: |
          # Verify routing via Gateway to Authentication service
          curl -f http://${{ secrets.STAGING_HOST }}:8112/AUTHENTICATION/actuator/health || exit 1

      - name: Performance Test
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils
          # Basic load test against health endpoint
          ab -n 200 -c 20 http://${{ secrets.STAGING_HOST }}:8100/actuator/health | tee ab_output.txt

      - name: Response Time Threshold Check (non-blocking)
        continue-on-error: true
        run: |
          THRESHOLD_MS=500
          P95=$(awk '/95%/ {print $2}' ab_output.txt)
          MEAN=$(awk -F '[: ]+' '/Time per request:/ {print $5; exit}' ab_output.txt)
          echo "p95(ms)=" $P95
          echo "mean(ms)=" $MEAN
          if [ -z "$P95" ] || [ -z "$MEAN" ]; then
            echo "Could not parse ab output; skipping assertion"
            exit 0
          fi
          if [ "$(printf '%.0f' "$P95")" -gt "$THRESHOLD_MS" ]; then
            echo "⚠️ p95 response time ($P95 ms) exceeds threshold ($THRESHOLD_MS ms)."
          else
            echo "✅ p95 response time within threshold."
          fi
          exit 0

      - name: Resource Usage Snapshot (non-blocking)
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            echo "Container list (grep authentication-staging):"
            docker ps --format '{{.ID}}\t{{.Names}}\t{{.Status}}' | grep authentication-staging || true
            echo "docker stats (single snapshot):"
            docker stats --no-stream --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' | grep authentication-staging || true

      - name: Notify Deployment
        if: success()
        run: |
          echo "✅ Staging deployment successful for nervus-authentication"
